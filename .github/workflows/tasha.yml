# ================================================================
# Tasha - Terraform Destroy
# ================================================================
# "Skin of evil" - Destroys infrastructure via HCP Terraform API
# Auto-rollback: polls for failed applies and destroys dev on failure
# Manual trigger requires typing "DESTROY" to confirm
# ================================================================

name: Tasha - Destroy

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes: check for failed applies

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment to destroy'
        required: true
        type: choice
        options: [dev, prod]
      confirm:
        description: 'Type "DESTROY" to confirm'
        required: true
        type: string

permissions:
  contents: read

concurrency:
  group: terraform-destroy
  cancel-in-progress: false

env:
  TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
  TF_ORG: ${{ vars.TF_CLOUD_ORG }}

jobs:
  # ══════════════════════════════════════════════════════════════════════════
  # Gate: Validate trigger (manual or auto-rollback)
  # ══════════════════════════════════════════════════════════════════════════
  gate:
    name: Validate
    runs-on: ubuntu-latest
    if: vars.ENABLE_TERRAFORM != 'false'
    outputs:
      should_destroy: ${{ steps.check.outputs.should_destroy }}
      environment: ${{ steps.check.outputs.environment }}
      workspace: ${{ steps.check.outputs.workspace }}
    steps:
      - name: Check trigger
        id: check
        run: |
          WS="witness-container-apps"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger: require DESTROY confirmation
            if [ "${{ github.event.inputs.confirm }}" = "DESTROY" ]; then
              ENV="${{ github.event.inputs.environment }}"
              echo "should_destroy=true" >> "$GITHUB_OUTPUT"
              echo "environment=${ENV}" >> "$GITHUB_OUTPUT"
              echo "workspace=${WS}" >> "$GITHUB_OUTPUT"
              echo "Manual destroy confirmed for ${ENV}"
            else
              echo "should_destroy=false" >> "$GITHUB_OUTPUT"
              echo "Confirmation failed. You must type 'DESTROY' exactly."
              exit 1
            fi
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            # Auto-rollback: check if workspace has a failed apply
            RESPONSE=$(curl -s \
              --header "Authorization: Bearer ${TF_API_TOKEN}" \
              "https://app.terraform.io/api/v2/organizations/${TF_ORG}/workspaces/${WS}")

            CURRENT_RUN_ID=$(echo "$RESPONSE" | jq -r '.data.relationships["current-run"].data.id // "none"')

            if [ "$CURRENT_RUN_ID" = "none" ] || [ "$CURRENT_RUN_ID" = "null" ]; then
              echo "No current run found"
              echo "should_destroy=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            RUN_STATUS=$(curl -s \
              --header "Authorization: Bearer ${TF_API_TOKEN}" \
              "https://app.terraform.io/api/v2/runs/${CURRENT_RUN_ID}" \
              | jq -r '.data.attributes.status')

            IS_DESTROY=$(curl -s \
              --header "Authorization: Bearer ${TF_API_TOKEN}" \
              "https://app.terraform.io/api/v2/runs/${CURRENT_RUN_ID}" \
              | jq -r '.data.attributes["is-destroy"]')

            echo "Current run ${CURRENT_RUN_ID}: status=${RUN_STATUS}, is_destroy=${IS_DESTROY}"

            if [ "$RUN_STATUS" = "errored" ] && [ "$IS_DESTROY" = "false" ]; then
              echo "Failed apply detected, triggering auto-rollback"
              echo "should_destroy=true" >> "$GITHUB_OUTPUT"
              echo "environment=dev" >> "$GITHUB_OUTPUT"
              echo "workspace=${WS}" >> "$GITHUB_OUTPUT"
            else
              echo "No failed apply, skipping"
              echo "should_destroy=false" >> "$GITHUB_OUTPUT"
            fi
          fi

  # ══════════════════════════════════════════════════════════════════════════
  # Destroy: Queue destroy run in HCP Terraform
  # ══════════════════════════════════════════════════════════════════════════
  destroy:
    name: Terraform Destroy
    needs: gate
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: needs.gate.outputs.should_destroy == 'true'
    environment:
      name: ${{ needs.gate.outputs.environment }}-destroy
    steps:
      - name: Get Workspace ID
        id: workspace
        run: |
          WORKSPACE_NAME="${{ needs.gate.outputs.workspace }}"

          WORKSPACE_ID=$(curl -s \
            --header "Authorization: Bearer ${TF_API_TOKEN}" \
            --header "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/organizations/${TF_ORG}/workspaces/${WORKSPACE_NAME}" \
            | jq -r '.data.id')

          if [ "$WORKSPACE_ID" = "null" ] || [ -z "$WORKSPACE_ID" ]; then
            echo "::error::Workspace '${WORKSPACE_NAME}' not found in org '${TF_ORG}'"
            exit 1
          fi

          echo "id=${WORKSPACE_ID}" >> "$GITHUB_OUTPUT"

      - name: Queue Destroy Run
        id: run
        run: |
          PAYLOAD=$(cat <<EOF
          {
            "data": {
              "attributes": {
                "is-destroy": true,
                "message": "Destroy triggered by Tasha workflow (@${{ github.actor }}, event: ${{ github.event_name }})"
              },
              "type": "runs",
              "relationships": {
                "workspace": {
                  "data": {
                    "type": "workspaces",
                    "id": "${{ steps.workspace.outputs.id }}"
                  }
                }
              }
            }
          }
          EOF
          )

          RESPONSE=$(curl -s \
            --header "Authorization: Bearer ${TF_API_TOKEN}" \
            --header "Content-Type: application/vnd.api+json" \
            --request POST \
            --data "${PAYLOAD}" \
            "https://app.terraform.io/api/v2/runs")

          RUN_ID=$(echo "$RESPONSE" | jq -r '.data.id')

          if [ "$RUN_ID" = "null" ] || [ -z "$RUN_ID" ]; then
            echo "::error::Failed to queue destroy run"
            echo "$RESPONSE" | jq .
            exit 1
          fi

          echo "run_id=${RUN_ID}" >> "$GITHUB_OUTPUT"
          echo "Destroy run queued: ${RUN_ID}"

      - name: Monitor Run
        run: |
          RUN_ID="${{ steps.run.outputs.run_id }}"
          echo "Monitoring run ${RUN_ID}..."

          for i in $(seq 1 90); do
            STATUS=$(curl -s \
              --header "Authorization: Bearer ${TF_API_TOKEN}" \
              "https://app.terraform.io/api/v2/runs/${RUN_ID}" \
              | jq -r '.data.attributes.status')

            echo "Status: ${STATUS}"

            case "$STATUS" in
              applied|discarded)
                echo "Run completed: ${STATUS}"
                break
                ;;
              errored|canceled|force_canceled)
                echo "::error::Run failed: ${STATUS}"
                exit 1
                ;;
              *)
                sleep 30
                ;;
            esac
          done

      - name: Destroy Summary
        if: always()
        run: |
          {
            echo "## Tasha - Destroy Run"
            echo ""
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| Environment | \`${{ needs.gate.outputs.environment }}\` |"
            echo "| Workspace | \`${{ needs.gate.outputs.workspace }}\` |"
            echo "| Run ID | \`${{ steps.run.outputs.run_id }}\` |"
            echo "| Trigger | ${{ github.event_name }} |"
            echo "| Triggered by | @${{ github.actor }} |"
            echo ""
            echo "[View in HCP Terraform](https://app.terraform.io/app/${{ vars.TF_CLOUD_ORG }}/workspaces/${{ needs.gate.outputs.workspace }}/runs/${{ steps.run.outputs.run_id }})"
          } >> "$GITHUB_STEP_SUMMARY"
