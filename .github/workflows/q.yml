# ================================================================
# Q - Terraform Tests
# ================================================================
# "I'm not talking about your limited three-dimensional thinking"
# Runs Terraform native test framework for infrastructure validation
# ================================================================

name: Q - Tests

on:
  push:
    branches: [main]
    paths:
      - 'deploy/terraform/**/*.tf'
      - 'deploy/terraform/**/*.tftest.hcl'
      - '.github/workflows/q.yml'
  pull_request:
    branches: [main]
    paths:
      - 'deploy/terraform/**/*.tf'
      - 'deploy/terraform/**/*.tftest.hcl'
      - '.github/workflows/q.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: terraform-test-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_VERSION: '1.7.0'

jobs:
  # ══════════════════════════════════════════════════════════════════════════
  # Discover test files
  # ══════════════════════════════════════════════════════════════════════════
  discover:
    name: Discover Tests
    runs-on: ubuntu-latest
    outputs:
      has_ca_tests: ${{ steps.check.outputs.has_ca_tests }}
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for test files
        id: check
        run: |
          # Check Container Apps tests
          if ls deploy/terraform/container-apps/*.tftest.hcl 2>/dev/null || \
             ls deploy/terraform/container-apps/tests/*.tftest.hcl 2>/dev/null; then
            echo "has_ca_tests=true" >> "$GITHUB_OUTPUT"
            echo "Found Container Apps test files"
          else
            echo "has_ca_tests=false" >> "$GITHUB_OUTPUT"
            echo "No Container Apps test files found"
          fi

      - name: Build matrix
        id: matrix
        run: |
          MATRIX="[]"

          if [ "${{ steps.check.outputs.has_ca_tests }}" = "true" ]; then
            MATRIX=$(echo "$MATRIX" | jq -c '. + ["container-apps"]')
          fi

          echo "matrix={\"infrastructure\":$MATRIX}" >> "$GITHUB_OUTPUT"
          echo "Test matrix: $MATRIX"

  # ══════════════════════════════════════════════════════════════════════════
  # Run Terraform tests
  # ══════════════════════════════════════════════════════════════════════════
  test:
    name: Test ${{ matrix.infrastructure }}
    needs: discover
    if: needs.discover.outputs.matrix != '{"infrastructure":[]}'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
    defaults:
      run:
        working-directory: deploy/terraform/${{ matrix.infrastructure }}

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: Run Terraform Tests
        id: test
        run: |
          set +e
          terraform test -no-color 2>&1 | tee test-output.txt
          EXIT_CODE=$?
          echo "exitcode=${EXIT_CODE}" >> "$GITHUB_OUTPUT"

          # Parse test results
          PASSED=$(grep -c "^  Pass" test-output.txt || echo "0")
          FAILED=$(grep -c "^  Fail" test-output.txt || echo "0")
          echo "passed=${PASSED}" >> "$GITHUB_OUTPUT"
          echo "failed=${FAILED}" >> "$GITHUB_OUTPUT"

          exit $EXIT_CODE
        continue-on-error: true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-test-${{ matrix.infrastructure }}
          path: deploy/terraform/${{ matrix.infrastructure }}/test-output.txt
          retention-days: 7

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let testOutput = '';
            try {
              testOutput = fs.readFileSync('deploy/terraform/${{ matrix.infrastructure }}/test-output.txt', 'utf8');
            } catch (e) {
              testOutput = 'No test output available';
            }

            const truncated = testOutput.length > 30000
              ? testOutput.substring(0, 30000) + '\n\n... (truncated)'
              : testOutput;

            const exitCode = '${{ steps.test.outputs.exitcode }}';
            const passed = '${{ steps.test.outputs.passed }}' || '0';
            const failed = '${{ steps.test.outputs.failed }}' || '0';
            const status = exitCode === '0' ? '[PASS]' : '[FAIL]';

            const body = `## ${status} Terraform Tests - \`${{ matrix.infrastructure }}\`

            | Metric | Count |
            |--------|-------|
            | Passed | ${passed} |
            | Failed | ${failed} |

            <details>
            <summary>Test Output</summary>

            \`\`\`
            ${truncated}
            \`\`\`

            </details>

            *Q has judged your infrastructure code.*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Terraform Tests') &&
              c.body.includes('${{ matrix.infrastructure }}')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Summary
        if: always()
        run: |
          {
            echo "## Q - Terraform Test Results: \`${{ matrix.infrastructure }}\`"
            echo ""
            echo "| Metric | Count |"
            echo "|--------|-------|"
            echo "| Passed | ${{ steps.test.outputs.passed || '0' }} |"
            echo "| Failed | ${{ steps.test.outputs.failed || '0' }} |"
            echo "| Exit Code | ${{ steps.test.outputs.exitcode }} |"
            echo ""
            if [ "${{ steps.test.outputs.exitcode }}" = "0" ]; then
              echo "**Status:** All tests passed"
            else
              echo "**Status:** Some tests failed"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Fail if tests failed
        if: steps.test.outputs.exitcode != '0'
        run: exit 1

  # ══════════════════════════════════════════════════════════════════════════
  # No tests found
  # ══════════════════════════════════════════════════════════════════════════
  no-tests:
    name: No Tests Found
    needs: discover
    if: needs.discover.outputs.matrix == '{"infrastructure":[]}'
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          {
            echo "## Q - No Terraform Tests Found"
            echo ""
            echo "No \`.tftest.hcl\` files found in:"
            echo "- \`deploy/terraform/container-apps/\`"
            echo ""
            echo "### Creating Tests"
            echo ""
            echo "Create test files using Terraform's native test framework:"
            echo ""
            echo "\`\`\`hcl"
            echo "# deploy/terraform/container-apps/tests/variables.tftest.hcl"
            echo ""
            echo "run \"validate_app_name\" {"
            echo "  command = plan"
            echo ""
            echo "  assert {"
            echo "    condition     = length(var.app_name) > 0"
            echo "    error_message = \"App name must not be empty\""
            echo "  }"
            echo "}"
            echo "\`\`\`"
            echo ""
            echo "See [Terraform Test Documentation](https://developer.hashicorp.com/terraform/language/tests)"
          } >> "$GITHUB_STEP_SUMMARY"
