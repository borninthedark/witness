# ================================================================
# Riker - Release Pipeline
# ================================================================
# "Make it so" - Semantic versioning and release management
# Retags the dev image in ECR for production release
# Uses conventional commits for version bumping:
#   - feat: -> minor bump
#   - fix: -> patch bump
#   - feat!: or BREAKING CHANGE: -> major bump
# ================================================================

name: Riker - Release

on:
  workflow_run:
    workflows: ['La Forge - Build']
    types: [completed]
    branches: [main]

  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        type: choice
        default: auto
        options:
          - auto
          - patch
          - minor
          - major
      prerelease:
        description: 'Create as prerelease?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write

concurrency:
  group: release
  cancel-in-progress: false

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  ECR_REPOSITORY: witness-dev

jobs:
  # ══════════════════════════════════════════════════════════════════════════
  # Determine Version
  # ══════════════════════════════════════════════════════════════════════════
  version:
    name: Version
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      version: ${{ steps.semver.outputs.new_tag }}
      changelog: ${{ steps.semver.outputs.changelog }}
      bump: ${{ steps.determine-bump.outputs.bump }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Determine bump type
        id: determine-bump
        run: |
          BUMP="${{ github.event.inputs.bump || 'auto' }}"

          if [ "$BUMP" = "auto" ]; then
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

            if [ -z "$LAST_TAG" ]; then
              COMMITS=$(git log --oneline)
            else
              COMMITS=$(git log --oneline ${LAST_TAG}..HEAD)
            fi

            if echo "$COMMITS" | grep -qiE '(^[a-f0-9]+ )?(\w+!:|BREAKING CHANGE)'; then
              BUMP="major"
            elif echo "$COMMITS" | grep -qiE '(^[a-f0-9]+ )?feat(\(.+\))?:'; then
              BUMP="minor"
            else
              BUMP="patch"
            fi

            echo "Auto-detected bump type: $BUMP"
          fi

          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"

      - name: Create version tag
        id: semver
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: main
          default_bump: ${{ steps.determine-bump.outputs.bump }}
          create_annotated_tag: true
          tag_prefix: v

      - name: Version Summary
        run: |
          {
            echo "## Version Determined"
            echo "- **New Version**: \`${{ steps.semver.outputs.new_tag }}\`"
            echo "- **Previous**: \`${{ steps.semver.outputs.previous_tag }}\`"
            echo "- **Bump Type**: \`${{ steps.determine-bump.outputs.bump }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

  # ══════════════════════════════════════════════════════════════════════════
  # Retag: Promote dev image to prod ECR repo
  # ══════════════════════════════════════════════════════════════════════════
  retag:
    name: Retag
    needs: version
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Retag dev to release
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          DEV_IMAGE="${ECR_REGISTRY}/${ECR_REPOSITORY}:dev"

          docker pull "${DEV_IMAGE}"

          docker tag "${DEV_IMAGE}" "${ECR_REGISTRY}/${ECR_REPOSITORY}:${VERSION}"
          docker tag "${DEV_IMAGE}" "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"

          docker push "${ECR_REGISTRY}/${ECR_REPOSITORY}:${VERSION}"
          docker push "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"

      - name: Retag Summary
        run: |
          {
            echo "## Container Image Tagged"
            echo "- **Version**: \`${{ needs.version.outputs.version }}\`"
            echo "- **Repository**: \`${ECR_REPOSITORY}\`"
            echo "- **Tags**: \`${{ needs.version.outputs.version }}\`, \`latest\`, \`dev\`"
          } >> "$GITHUB_STEP_SUMMARY"

  # ══════════════════════════════════════════════════════════════════════════
  # Release: Create GitHub Release
  # ══════════════════════════════════════════════════════════════════════════
  release:
    name: Release
    needs: [version, retag]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        run: |
          cat > /tmp/release-notes.md << 'EOF'
          ## What's Changed

          ${{ needs.version.outputs.changelog }}

          ## Container Image

          Image tagged as `witness-dev:${{ needs.version.outputs.version }}`.

          ## Image Details

          | Property | Value |
          |----------|-------|
          | ECR Repository | `witness-dev` |
          | Version | `${{ needs.version.outputs.version }}` |
          | Tags | `${{ needs.version.outputs.version }}`, `latest`, `dev` |
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.version }}
          name: ${{ needs.version.outputs.version }}
          body_path: /tmp/release-notes.md
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          {
            echo "## Release Published"
            echo ""
            echo "- **Version**: [\`${{ needs.version.outputs.version }}\`](https://github.com/${{ github.repository }}/releases/tag/${{ needs.version.outputs.version }})"
            echo "- **ECR**: \`witness-dev:${{ needs.version.outputs.version }}\`"
            echo ""
            echo "### Changelog"
            echo "${{ needs.version.outputs.changelog }}"
          } >> "$GITHUB_STEP_SUMMARY"
