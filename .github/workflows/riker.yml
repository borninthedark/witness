# ================================================================
# Riker - Release Pipeline
# ================================================================
# "Make it so" - Semantic versioning and release management
# Pulls the dev image from GHCR (built by Picard), retags for release
# Uses conventional commits for version bumping:
#   - feat: -> minor bump
#   - fix: -> patch bump
#   - feat!: or BREAKING CHANGE: -> major bump
# ================================================================

name: Riker - Release

on:
  workflow_run:
    workflows: ['Picard - Build']
    types: [completed]
    branches: [main]

  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        type: choice
        default: auto
        options:
          - auto
          - patch
          - minor
          - major
      prerelease:
        description: 'Create as prerelease?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  id-token: write

concurrency:
  group: release
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_REPO: ${{ github.repository }}

jobs:
  # ══════════════════════════════════════════════════════════════════════════
  # Determine Version
  # ══════════════════════════════════════════════════════════════════════════
  version:
    name: Version
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      version: ${{ steps.semver.outputs.new_tag }}
      changelog: ${{ steps.semver.outputs.changelog }}
      bump: ${{ steps.determine-bump.outputs.bump }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Determine bump type
        id: determine-bump
        run: |
          BUMP="${{ github.event.inputs.bump || 'auto' }}"

          if [ "$BUMP" = "auto" ]; then
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

            if [ -z "$LAST_TAG" ]; then
              COMMITS=$(git log --oneline)
            else
              COMMITS=$(git log --oneline ${LAST_TAG}..HEAD)
            fi

            if echo "$COMMITS" | grep -qiE '(^[a-f0-9]+ )?(\w+!:|BREAKING CHANGE)'; then
              BUMP="major"
            elif echo "$COMMITS" | grep -qiE '(^[a-f0-9]+ )?feat(\(.+\))?:'; then
              BUMP="minor"
            else
              BUMP="patch"
            fi

            echo "Auto-detected bump type: $BUMP"
          fi

          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"

      - name: Create version tag
        id: semver
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: main
          default_bump: ${{ steps.determine-bump.outputs.bump }}
          create_annotated_tag: true
          tag_prefix: v

      - name: Version Summary
        run: |
          {
            echo "## Version Determined"
            echo "- **New Version**: \`${{ steps.semver.outputs.new_tag }}\`"
            echo "- **Previous**: \`${{ steps.semver.outputs.previous_tag }}\`"
            echo "- **Bump Type**: \`${{ steps.determine-bump.outputs.bump }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

  # ══════════════════════════════════════════════════════════════════════════
  # Retag: Pull dev image from GHCR, push with release tags
  # ══════════════════════════════════════════════════════════════════════════
  retag:
    name: Retag
    needs: version
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      digest: ${{ steps.digest.outputs.digest }}

    steps:
      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | skopeo login ${{ env.REGISTRY }} \
            --username ${{ github.actor }} \
            --password-stdin

      - name: Copy dev image to release tags
        run: |
          SRC="${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:dev"
          DST="${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}"

          skopeo copy "docker://${SRC}" "docker://${DST}:${{ needs.version.outputs.version }}"
          skopeo copy "docker://${SRC}" "docker://${DST}:latest"
          skopeo copy "docker://${SRC}" "docker://${DST}:prod"

      - name: Get digest
        id: digest
        run: |
          DIGEST=$(skopeo inspect --format '{{.Digest}}' \
            "docker://${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ needs.version.outputs.version }}")
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"

      - name: Retag Summary
        run: |
          {
            echo "## Container Image Retagged"
            echo "- **Version**: \`${{ needs.version.outputs.version }}\`"
            echo "- **Tags**: \`latest\`, \`prod\`, \`${{ needs.version.outputs.version }}\`"
            echo "- **Digest**: \`${{ steps.digest.outputs.digest }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

  # ══════════════════════════════════════════════════════════════════════════
  # Sign: Cosign keyless signing via Sigstore OIDC
  # ══════════════════════════════════════════════════════════════════════════
  sign:
    name: Sign
    needs: [version, retag]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.5.0

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign image
        run: |
          cosign sign --yes "${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}@${{ needs.retag.outputs.digest }}"

      - name: Verify signature
        run: |
          cosign verify \
            --certificate-identity-regexp='.*' \
            --certificate-oidc-issuer-regexp='.*' \
            "${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}@${{ needs.retag.outputs.digest }}"

  # ══════════════════════════════════════════════════════════════════════════
  # Release: Create GitHub Release
  # ══════════════════════════════════════════════════════════════════════════
  release:
    name: Release
    needs: [version, retag, sign]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        run: |
          cat > /tmp/release-notes.md << 'EOF'
          ## What's Changed

          ${{ needs.version.outputs.changelog }}

          ## Container Image

          ```bash
          # Pull the release image
          podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ needs.version.outputs.version }}

          # Or use the latest tag
          podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:latest

          # Verify image signature
          cosign verify \
            --certificate-identity-regexp='.*' \
            --certificate-oidc-issuer-regexp='.*' \
            ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ needs.version.outputs.version }}
          ```

          ## Image Details

          | Property | Value |
          |----------|-------|
          | Registry | `${{ env.REGISTRY }}` |
          | Repository | `${{ env.IMAGE_REPO }}` |
          | Version | `${{ needs.version.outputs.version }}` |
          | Digest | `${{ needs.retag.outputs.digest }}` |
          | Signed | Yes (Sigstore keyless OIDC) |
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.version }}
          name: ${{ needs.version.outputs.version }}
          body_path: /tmp/release-notes.md
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          {
            echo "## Release Published"
            echo ""
            echo "- **Version**: [\`${{ needs.version.outputs.version }}\`](https://github.com/${{ github.repository }}/releases/tag/${{ needs.version.outputs.version }})"
            echo "- **Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ needs.version.outputs.version }}\`"
            echo "- **Signed**: Yes"
            echo ""
            echo "### Changelog"
            echo "${{ needs.version.outputs.changelog }}"
          } >> "$GITHUB_STEP_SUMMARY"
