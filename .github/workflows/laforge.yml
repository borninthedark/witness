# ================================================================
# La Forge - Terraform CI Gate
# ================================================================
# "I can make it work" - CI and security gate for HCP Terraform
# VCS-driven: HCP Terraform handles plan/apply automatically
# This workflow runs Data CI + Worf security as quality gates
# ================================================================

name: La Forge - Deploy

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - '.github/workflows/laforge.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options: [dev, prod]

permissions:
  contents: read
  security-events: write
  pull-requests: write

concurrency:
  group: terraform-deploy
  cancel-in-progress: false

env:
  TF_CLOUD_ORGANIZATION: DefiantEmissary

jobs:
  # ══════════════════════════════════════════════════════════════════════════
  # Prerequisites: Run Data CI and Worf security scans
  # ══════════════════════════════════════════════════════════════════════════
  data:
    name: Data - CI
    uses: ./.github/workflows/data.yml

  worf:
    name: Worf - Security
    uses: ./.github/workflows/worf.yml

  # ══════════════════════════════════════════════════════════════════════════
  # Gate: CI + Security passed, HCP Terraform VCS handles plan/apply
  # ══════════════════════════════════════════════════════════════════════════
  gate:
    name: VCS Gate
    needs: [data, worf]
    runs-on: ubuntu-latest
    if: vars.ENABLE_TERRAFORM != 'false'
    steps:
      - name: Gate Summary
        run: |
          {
            echo "## La Forge - VCS Gate"
            echo ""
            echo "CI and security checks passed."
            echo "HCP Terraform VCS workflow handles plan/apply."
            echo ""
            echo "| Workspace | Working Directory |"
            echo "|-----------|-------------------|"
            echo "| \`witness-dev\` | \`terraform/dev\` |"
            echo "| \`witness-prod\` | \`terraform/prod\` |"
            echo ""
            echo "[View workspaces](https://app.terraform.io/app/DefiantEmissary/workspaces)"
          } >> "$GITHUB_STEP_SUMMARY"
