# ================================================================
# Worf - Terraform Security & Validation
# ================================================================
# "Today is a good day to scan" - Security scans and validation
# Scans both dev and prod workspace roots + shared module
# ================================================================

name: Worf - Security

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write
  pull-requests: write

concurrency:
  group: terraform-security-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_VERSION: '1.14.2'

jobs:
  # ══════════════════════════════════════════════════════════════════════════
  # Scan each environment workspace
  # ══════════════════════════════════════════════════════════════════════════
  security-scan:
    name: Scan ${{ matrix.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        environment: [dev, prod]
    defaults:
      run:
        working-directory: terraform/${{ matrix.environment }}

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive -diff
        continue-on-error: true

      - name: Checkov Security Scan
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/${{ matrix.environment }}
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,checkov-${{ matrix.environment }}.sarif
          soft_fail: true
          skip_check: CKV_AZURE_4,CKV_AZURE_7,CKV2_AZURE_1,CKV2_AZURE_18,CKV2_AZURE_33
        continue-on-error: true

      - name: Upload Checkov SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-${{ matrix.environment }}.sarif
          category: checkov-${{ matrix.environment }}
        continue-on-error: true

      - name: Trivy Config Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: terraform/${{ matrix.environment }}
          format: 'sarif'
          output: 'trivy-${{ matrix.environment }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true

      - name: Upload Trivy SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-${{ matrix.environment }}.sarif
          category: trivy-config-${{ matrix.environment }}
        continue-on-error: true

      - name: Security Summary
        if: always()
        run: |
          {
            echo "## Worf - Security Scan: \`${{ matrix.environment }}\`"
            echo ""
            echo "| Check | Status |"
            echo "|-------|--------|"
            echo "| Validate | ${{ steps.validate.outcome == 'success' && 'OK' || 'FAIL' }} |"
            echo "| Format | ${{ steps.fmt.outcome == 'success' && 'OK' || 'WARN' }} |"
            echo "| Checkov | ${{ steps.checkov.outcome == 'success' && 'OK' || 'WARN' }} |"
            echo ""
            echo "Security findings uploaded to GitHub Security tab."
          } >> "$GITHUB_STEP_SUMMARY"

  # ══════════════════════════════════════════════════════════════════════════
  # Terraform Unit Tests (run from dev workspace)
  # ══════════════════════════════════════════════════════════════════════════
  terraform-test:
    name: Terraform Tests
    needs: security-scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Check for test files
        id: check-tests
        run: |
          if ls terraform/dev/*.tftest.hcl 2>/dev/null || \
             ls terraform/dev/tests/*.tftest.hcl 2>/dev/null; then
            echo "has_tests=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_tests=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Terraform Init
        if: steps.check-tests.outputs.has_tests == 'true'
        working-directory: terraform/dev
        run: terraform init -backend=false

      - name: Run Terraform Tests
        if: steps.check-tests.outputs.has_tests == 'true'
        working-directory: terraform/dev
        run: terraform test -no-color
        continue-on-error: true

      - name: Test Summary
        if: always()
        run: |
          {
            echo "## Worf - Terraform Tests"
            echo ""
            if [ "${{ steps.check-tests.outputs.has_tests }}" = "true" ]; then
              echo "Tests executed from \`terraform/dev\`"
            else
              echo "No test files found (*.tftest.hcl)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # ══════════════════════════════════════════════════════════════════════════
  # Cost Estimation (optional)
  # ══════════════════════════════════════════════════════════════════════════
  cost-estimate:
    name: Cost Estimate
    needs: terraform-test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        environment: [dev, prod]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
        continue-on-error: true

      - name: Generate Cost Estimate
        if: env.INFRACOST_API_KEY != ''
        run: |
          infracost breakdown \
            --path=terraform/${{ matrix.environment }} \
            --format=json \
            --out-file=/tmp/infracost-${{ matrix.environment }}.json
        env:
          INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
        continue-on-error: true

      - name: Post Cost Comment
        if: env.INFRACOST_API_KEY != ''
        uses: infracost/actions/comment@v1
        with:
          path: /tmp/infracost-${{ matrix.environment }}.json
          behavior: update
        env:
          INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
        continue-on-error: true
