# ================================================================
# Worf - Terraform Security & Validation
# ================================================================
# "Today is a good day to scan" - Security scans and validation
# Scans both dev and prod workspace roots + shared modules
# AWS Checkov checks + tfsec
# ================================================================

name: Worf - Security

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write
  pull-requests: write

concurrency:
  group: terraform-security-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_VERSION: '1.14.2'

jobs:
  # ══════════════════════════════════════════════════════════════════════════
  # Scan each environment workspace
  # ══════════════════════════════════════════════════════════════════════════
  security-scan:
    name: Scan ${{ matrix.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        environment: [dev, prod]
    defaults:
      run:
        working-directory: terraform/${{ matrix.environment }}

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Checkov Security Scan
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/${{ matrix.environment }}
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,checkov-${{ matrix.environment }}.sarif
          soft_fail: true
          skip_check: CKV_AWS_144,CKV_AWS_145,CKV2_AWS_62
        continue-on-error: true

      - name: Upload Checkov SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-${{ matrix.environment }}.sarif
          category: checkov-${{ matrix.environment }}
        continue-on-error: true

      - name: Install tfsec
        run: |
          curl -fsSL https://github.com/aquasecurity/tfsec/releases/latest/download/tfsec-linux-amd64 -o /usr/local/bin/tfsec
          chmod +x /usr/local/bin/tfsec

      - name: tfsec Scan
        id: tfsec
        run: |
          cd "${{ github.workspace }}"
          tfsec terraform/${{ matrix.environment }} --format sarif --out tfsec-${{ matrix.environment }}.sarif || true
        continue-on-error: true

      - name: Upload tfsec SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: tfsec-${{ matrix.environment }}.sarif
          category: tfsec-${{ matrix.environment }}
        continue-on-error: true

      - name: Trivy Config Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: terraform/${{ matrix.environment }}
          format: 'sarif'
          output: 'trivy-${{ matrix.environment }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true

      - name: Upload Trivy SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-${{ matrix.environment }}.sarif
          category: trivy-config-${{ matrix.environment }}
        continue-on-error: true

      - name: Security Summary
        if: always()
        run: |
          {
            echo "## Worf - Security Scan: \`${{ matrix.environment }}\`"
            echo ""
            echo "| Check | Status |"
            echo "|-------|--------|"
            echo "| Checkov | ${{ steps.checkov.outcome == 'success' && 'OK' || 'WARN' }} |"
            echo "| tfsec | ${{ steps.tfsec.outcome == 'success' && 'OK' || 'WARN' }} |"
            echo ""
            echo "Security findings uploaded to GitHub Security tab."
          } >> "$GITHUB_STEP_SUMMARY"

  # ══════════════════════════════════════════════════════════════════════════
  # Terraform Unit Tests (run from dev workspace)
  # ══════════════════════════════════════════════════════════════════════════
  terraform-test:
    name: Terraform Tests
    needs: security-scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Check for test files
        id: check-tests
        run: |
          if ls terraform/dev/*.tftest.hcl 2>/dev/null || \
             ls terraform/dev/tests/*.tftest.hcl 2>/dev/null; then
            echo "has_tests=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_tests=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Terraform Init
        if: steps.check-tests.outputs.has_tests == 'true'
        working-directory: terraform/dev
        run: terraform init -backend=false

      - name: Run Terraform Tests
        if: steps.check-tests.outputs.has_tests == 'true'
        working-directory: terraform/dev
        run: terraform test -no-color
        continue-on-error: true

      - name: Test Summary
        if: always()
        run: |
          {
            echo "## Worf - Terraform Tests"
            echo ""
            if [ "${{ steps.check-tests.outputs.has_tests }}" = "true" ]; then
              echo "Tests executed from \`terraform/dev\`"
            else
              echo "No test files found (*.tftest.hcl)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
