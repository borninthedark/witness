# ================================================================
# Picard - CI/CD Orchestrator
# ================================================================
# "Make it so" - Central orchestrator for all CI/CD
# Coordinates Data (CI), Worf (security), and La Forge (build)
# on every push to main. HCP Terraform VCS handles plan/apply.
# ================================================================

name: Picard - Deploy

on:
  push:
    branches: [main]
    paths:
      - 'fitness/**'
      - 'tools/**'
      - 'tests/**'
      - 'terraform/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - 'container/**'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  actions: read
  security-events: write
  pull-requests: write
  id-token: write

concurrency:
  group: picard-${{ github.ref }}
  cancel-in-progress: false

env:
  TF_CLOUD_ORGANIZATION: DefiantEmissary

jobs:
  # ══════════════════════════════════════════════════════════════════════════
  # Stage 1: Quality gates (parallel)
  # ══════════════════════════════════════════════════════════════════════════
  data:
    name: Data - CI
    uses: ./.github/workflows/data.yml

  worf:
    name: Worf - Security
    uses: ./.github/workflows/worf.yml

  # ══════════════════════════════════════════════════════════════════════════
  # Stage 2: Build (after CI passes)
  # ══════════════════════════════════════════════════════════════════════════
  laforge:
    name: La Forge - Build
    needs: [data, worf]
    uses: ./.github/workflows/laforge.yml
    secrets: inherit

  # ══════════════════════════════════════════════════════════════════════════
  # Stage 3: Terraform VCS gate (after all checks pass)
  # ══════════════════════════════════════════════════════════════════════════
  gate:
    name: VCS Gate
    needs: [data, worf, laforge]
    runs-on: ubuntu-latest
    if: always() && !failure()
    steps:
      - name: Gate Summary
        run: |
          {
            echo "## Picard - Pipeline Complete"
            echo ""
            echo "| Stage | Workflow | Status |"
            echo "|-------|----------|--------|"
            echo "| CI | Data | ${{ needs.data.result }} |"
            echo "| Security | Worf | ${{ needs.worf.result }} |"
            echo "| Build | La Forge | ${{ needs.laforge.result }} |"
            echo ""
            echo "HCP Terraform VCS workflow handles plan/apply for AWS."
            echo ""
            echo "| Workspace | Working Directory |"
            echo "|-----------|-------------------|"
            echo "| \`witness-dev\` | \`terraform/aws/dev\` |"
            echo "| \`witness-prod\` | \`terraform/aws/prod\` |"
            echo ""
            echo "[View workspaces](https://app.terraform.io/app/DefiantEmissary/workspaces)"
          } >> "$GITHUB_STEP_SUMMARY"
