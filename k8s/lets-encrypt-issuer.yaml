#!/usr/bin/env kubectl apply -f
# ══════════════════════════════════════════════════════════════════════════════
# Let's Encrypt Cluster Issuers - cert-manager Configuration
# ══════════════════════════════════════════════════════════════════════════════
#
# PREREQUISITE: cert-manager must be installed in the cluster
#
# For Azure AKS with App Routing add-on, cert-manager is automatically installed.
# For other clusters, install cert-manager first:
#   kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
#
# USAGE:
#   1. Update the email addresses below with your actual contact email
#   2. Apply this file: kubectl apply -f k8s/lets-encrypt-issuer.yaml
#   3. Test with staging issuer first, then switch to production
#
# RATE LIMITS:
#   - Staging: No rate limits (use for testing)
#   - Production: 50 certificates per registered domain per week
#
# ══════════════════════════════════════════════════════════════════════════════
---
# ──────────────────────────────────────────────────────────────────────────────
# STAGING ISSUER - Use for testing certificate issuance
# ──────────────────────────────────────────────────────────────────────────────
# The staging issuer creates certificates that are NOT trusted by browsers.
# Use this for testing your configuration before switching to production.
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: issuer
spec:
  acme:
    # Let's Encrypt ACME staging server
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    # Email for certificate expiration notifications
    email: info@princetonstrong.online
    # Secret to store the ACME account private key
    privateKeySecretRef:
      name: letsencrypt-staging
    # HTTP-01 challenge solver configuration
    solvers:
      - http01:
          ingress:
            class: webapprouting.kubernetes.azure.com  # Azure App Routing ingress class

---
# ──────────────────────────────────────────────────────────────────────────────
# PRODUCTION ISSUER - Use for real, trusted certificates
# ──────────────────────────────────────────────────────────────────────────────
# The production issuer creates browser-trusted certificates.
# WARNING: Subject to rate limits (50 certs per domain per week).
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: issuer
spec:
  acme:
    # Let's Encrypt ACME production server
    server: https://acme-v02.api.letsencrypt.org/directory
    # Email for certificate expiration notifications and account recovery
    email: info@princetonstrong.online
    # Secret to store the ACME account private key
    privateKeySecretRef:
      name: letsencrypt-prod
    # HTTP-01 challenge solver configuration
    solvers:
      - http01:
          ingress:
            class: webapprouting.kubernetes.azure.com  # Azure App Routing ingress class
