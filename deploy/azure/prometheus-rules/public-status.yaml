# Public Status Recording Rules
# Deploy to AKS: kubectl apply -f deploy/azure/prometheus-rules/public-status.yaml
#
# These recording rules create sanitized, aggregated metrics for public consumption.
# All labels (paths, IPs, user agents) are stripped to prevent information leakage.

apiVersion: v1
kind: ConfigMap
metadata:
  name: public-status-rules
  namespace: kube-system
  labels:
    app: prometheus
    component: recording-rules
data:
  public-status.yml: |
    groups:
      - name: public_status
        interval: 60s
        rules:
          # HTTP Request Latency - 95th percentile (milliseconds)
          # Aggregates all endpoints, no path/method labels
          - record: public:http_request_p95_ms
            expr: |
              histogram_quantile(0.95,
                sum(rate(http_request_duration_seconds_bucket{job="fitness-app"}[5m])) by (le)
              ) * 1000

          # HTTP Error Rate - Percentage of 5xx responses
          # No endpoint or user identification
          - record: public:http_error_rate_pct
            expr: |
              (
                sum(rate(http_requests_total{status=~"5.."}[5m]))
                /
                sum(rate(http_requests_total[5m]))
              ) * 100

          # Requests Per Second - Rolling 5 minute average
          # Total throughput only, no breakdown
          - record: public:http_rps
            expr: |
              sum(rate(http_requests_total{job="fitness-app"}[5m]))

          # 30-Day Availability - SLA style percentage
          # Based on request success rate over 30 days
          - record: public:availability_pct_30d
            expr: |
              (
                1 - (
                  sum(increase(http_requests_total{status=~"5.."}[30d]))
                  /
                  sum(increase(http_requests_total[30d]))
                )
              ) * 100

          # Time Since Last Deploy - Hours
          # Deployment age in hours
          - record: public:deploy_age_hours
            expr: |
              (time() - app_deploy_timestamp_seconds) / 3600

          # Synthetic Probe Success Rate - Health check pass/fail
          # Aggregated probe results, no URL exposure
          - record: public:probe_success_rate
            expr: |
              avg_over_time(probe_success{job="blackbox"}[5m])

          # Database Connection Pool - Available connections percentage
          # Shows DB health without exposing connection strings
          - record: public:db_pool_available_pct
            expr: |
              (
                db_pool_connections_idle
                /
                db_pool_connections_max
              ) * 100

          # Memory Usage - Percentage
          # Container memory utilization
          - record: public:memory_usage_pct
            expr: |
              (
                container_memory_working_set_bytes{pod=~"fitness-app.*"}
                /
                container_spec_memory_limit_bytes{pod=~"fitness-app.*"}
              ) * 100
