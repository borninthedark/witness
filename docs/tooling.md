# Tooling & Workflows

## Testing

- Run the entire suite with `python -m pytest`.
- Smoke tests cover uptime endpoints and HTML rendering.
- Integration tests exercise the résumé generator and certification de-duplication
  logic with a temporary SQLite database.
- `pre-commit` can trigger `pytest` automatically; enable the hook in
  `.pre-commit-config.yaml` when you want the suite to gate commits. Full logs (pass or
  fail) are written to `.precommit_logs/pytest-<timestamp>.log` and surfaced in the
  `/reports/operations` dashboard.

## Formatting & Linters

- `ruff` enforces lint rules (E/F/B/UP/SIM) and can auto-fix many issues via
  `ruff check --fix .`.
- `isort` keeps imports sorted (Black profile), followed by `black` for formatting.
  Both tools share the 100-character width.
- `.pre-commit-config.yaml` runs Black, isort, Flake8, mypy, Bandit, ShellCheck,
  Hadolint, Trivy FS, pytest, and the security-report generator. Install via
  `pip install pre-commit` then `pre-commit install`.
- Type checking is enforced with `mypy --strict`; FastAPI and Pydantic extras are
  bundled via the hook dependencies.
- Styles are authored in `fitness/static/styles.scss`. Use
  `python scripts/build_styles.py` to compile SCSS to CSS (requires `libsass` from
  `requirements.txt`).
- Security and static analysis hooks include:
  - `bandit` scanning Python sources at level `-ll`.
  - `trivy fs` (local hook). Install Trivy from
    <https://github.com/aquasecurity/trivy> so the binary is on `PATH`.
  - `shellcheck` and `hadolint` for shell scripts and Dockerfiles.

## DRY Enforcement

- `scripts/check-dry.py` scans Python files for duplicated code blocks.
- Usage examples:
  - `python scripts/check-dry.py`
  - `python scripts/check-dry.py --functions-only --min-lines 8`
- The command exits non-zero when duplication is detected, making it CI friendly.
- Continuous enforcement happens via `pytest`
  (`tests/test_dry.py` runs the functions-only scan with the same thresholds used
  previously in pre-commit).

## Contact Channel & Tailwind Ops

- The LCARS contact page ships with Tailwind via CDN and Google Fonts, so no
  additional build step is required for deployments.
- SMTP delivery is optional. When `MAIL_FROM`, `MAIL_TO`, and `SMTP_*` variables are
  absent, submissions are only persisted to `fitness/data/contact-messages.jsonl`
  and echoed to logs.
- Future HTMX upgrades can target the `#contact-panel` element and swap the rendered
  block when the `HX-Request` header is present.
- Store SMTP secrets in your platform’s secret manager (Azure Key Vault,
  Kubernetes Secret, etc.) and surface them to the container via environment
  variables.

## Résumé & Assets

- `fitness/services/pdf_resume.py` reads `fitness/data/resume-data.yaml`, generates
  `PAS-Resume.pdf`, and stores it under `fitness/data/`.
- Accent and page colors are driven by `fitness/config.py`, aligning with the
  anthracite theme and Nord palette request.
- Certification metadata comes from `fitness/constants.py`, keeping titles, issuers,
  and verification endpoints in sync with uploaded PDFs.
- Contact form submissions persist to `fitness/data/contact-messages.jsonl`; redact
  sensitive data before committing logs.

## Pre-commit

Pre-commit ensures a consistent set of checks run before every commit:

1. Install once: `pip install pre-commit`.
2. Install git hooks: `pre-commit install` (add `--hook-type commit-msg` or
   `pre-push` if desired).
3. Run everything once (especially after changing configs) with
   `pre-commit run --all-files`.

### Key details

- Hooks log to `.precommit_logs/HOOKNAME-<timestamp>.log` (ignored by git and
  Docker).
- `pytest` runs via the local hook, so every commit automatically runs the full test
  suite.
- `python scripts/generate-security-reports.py` runs via a hook and emits
  timestamped Markdown under `reports/`.
- Trivy FS runs locally. Install Trivy from
  <https://github.com/aquasecurity/trivy> so the hook can execute. The default hook
  points to `/usr/local/bin/trivy`; update `.pre-commit-config.yaml` if your binary
  lives elsewhere.
- Update hooks periodically with `pre-commit autoupdate`.

### Tips

- Running `pre-commit run` with no args only checks staged files (fast for
  incremental commits).
- To temporarily skip (not recommended), use `git commit --no-verify`.
- Need a hermetic environment? Run `python scripts/run-precommit-podman.py` to
  execute hooks inside the Podman container defined by `Dockerfile.pre-commit`.

## Operations & Security Dashboards

- The **Reports → Operations** view aggregates the latest `.precommit_logs` output so
  you can see the status, timestamps, and snippets for each hook without tailing files.
  It also links to the newest `SECURITY_SUMMARY-*.md` generated by
  `scripts/generate-security-reports.py`.
- The **Reports → Security** view streams the Gentoo Linux Security Advisory RSS feed.
  When the feed cannot be fetched, the UI reports the error instead of crashing the
  page.

## README documentation generator

The `scripts/update_readme.py` helper regenerates the "Documentation" section in
`README.md` based on the markdown files under `docs/`. After adding or editing docs,
run:

```bash
python scripts/update_readme.py
```

This keeps the README's doc index in sync without manual edits.

## GitHub Actions CI/CD

The project uses Star Trek TNG-themed GitHub Actions workflows organized into two pipelines:

### Application Pipeline

1. **Data - CI** (`data.yml`) - On push/PR to main
   - Python linting (Ruff, MyPy) and testing (pytest)
   - Containerfile linting (Hadolint), ShellCheck, Semgrep
   - Pure code quality, no image build

2. **Picard - Build** (`picard.yml`) - Scheduled / manual
   - Container image build with Buildah (OCI format)
   - Security scanning with Trivy
   - Image signing with Cosign (Sigstore keyless OIDC)
   - Push to GHCR with `dev` and `sha-*` tags

3. **Riker - Release** (`riker.yml`) - After Picard succeeds
   - Pulls `dev` image from GHCR, retags via `skopeo copy`
   - Semantic versioning via conventional commits
   - GitHub release creation with changelog
   - Production image tags (`latest`, `prod`, `vX.Y.Z`)

4. **Troi - Docs** (`troi.yml`) - After Picard / scheduled
   - Coverage badge updates
   - Security report generation
   - Documentation validation

### Infrastructure Pipeline (HCP Terraform VCS-driven)

Plan and apply handled by HCP Terraform (VCS-driven, workspace: `witness-container-apps`).
La Forge orchestrates Data CI + Worf security scans as a quality gate. On push to `deploy/terraform/**`:

1. **Worf - Security** (`worf.yml`) - GitHub Actions
   - Checkov security scanning
   - tfsec static analysis
   - Trivy config scanning
   - Terraform validate, format check, and tests
   - Jobs run sequentially: scan -> test -> cost estimate

2. **La Forge - Gate** (`laforge.yml`) - On push to terraform paths / manual
   - Calls Data CI and Worf Security as reusable workflows
   - Quality gate: both must pass before HCP TF auto-plan proceeds
   - Reports workspace status after checks pass

   **HCP Terraform** - VCS-driven (auto-triggers on push)
   - Auto-plans on push to configured working directory
   - Manual confirm required before apply
   - Workspace: `witness-container-apps`

3. **Crusher - Health** (`crusher.yml`) - Scheduled / on-demand
   - Pipeline health monitoring (workflow status)
   - Application health checks (/healthz, /readyz)
   - HCP Terraform workspace status via API

4. **Tasha - Destroy** (`tasha.yml`) - Scheduled (auto-rollback) / manual
   - Polls HCP TF for failed applies, auto-destroys on failure
   - Manual trigger requires typing "DESTROY" to confirm
   - Queues destroy runs via HCP Terraform API
   - Workspace: `witness-container-apps`

### Required Secrets

| Secret | Purpose |
|--------|---------|
| `AZURE_CLIENT_ID` | Azure OIDC authentication |
| `AZURE_TENANT_ID` | Azure OIDC authentication |
| `AZURE_SUBSCRIPTION_ID` | Azure OIDC authentication |
| `TF_API_TOKEN` | HCP Terraform API token |
| `APP_SECRET_KEY` | Application secret |

### Required Variables

| Variable | Purpose |
|----------|---------|
| `TF_CLOUD_ORG` | HCP Terraform organization (`DefiantEmissary`) |
| `ENABLE_TERRAFORM` | Set to `false` to disable Terraform jobs (enabled by default) |
| `ENABLE_STATUS_DASHBOARD` | Enable Grafana snapshot updates |
